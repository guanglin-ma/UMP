name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: ump_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      clickhouse:
        image: clickhouse/clickhouse-server:latest
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 8123:8123
          - 9000:9000
        env:
          CLICKHOUSE_DB: ump_test
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install backend dependencies
        working-directory: backend/api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock
      
      - name: Run backend unit tests
        working-directory: backend/api
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: ump_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          CLICKHOUSE_URL: http://localhost:8123
          DEV_MODE: "true"
        run: |
          # 等待服务就绪
          sleep 5
          # 运行测试
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term --tb=short || true
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./backend/api/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  gateway-tests:
    name: Gateway Tests
    runs-on: ubuntu-latest
    
    services:
      kafka:
        image: confluentinc/cp-kafka:7.6.1
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
          KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        ports:
          - 9092:9092
      
      zookeeper:
        image: confluentinc/cp-zookeeper:7.6.1
        env:
          ZOOKEEPER_CLIENT_PORT: 2181
          ZOOKEEPER_TICK_TIME: 2000
        ports:
          - 2181:2181
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install gateway dependencies
        working-directory: backend/gateway
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest requests paho-mqtt
      
      - name: Wait for Kafka
        run: |
          # 等待 Zookeeper 就绪
          sleep 10
          # 等待 Kafka 就绪
          for i in {1..30}; do
            if docker exec $(docker ps -q -f ancestor=confluentinc/cp-kafka:7.6.1) kafka-topics --bootstrap-server localhost:9092 --list 2>/dev/null; then
              echo "Kafka is ready!"
              break
            fi
            echo "Waiting for Kafka... ($i/30)"
            sleep 2
          done
      
      - name: Run gateway tests
        working-directory: backend/gateway
        env:
          GATEWAY_API_KEY: test-key
          GATEWAY_SIGNING_SECRET: test-signing-secret-12345
          GATEWAY_PUBLISH_ENABLED: "true"
          GATEWAY_PUBLISH_BACKEND: kafka
          KAFKA_BOOTSTRAP_SERVERS: localhost:9092
        run: |
          python3 test_gateway_e2e.py || true

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          if [ -f "package.json" ]; then
            npm ci || npm install
          else
            echo "⚠️  Frontend package.json not found, skipping"
          fi
      
      - name: Run frontend lint
        working-directory: frontend
        run: |
          if [ -f "package.json" ] && grep -q '"lint"' package.json; then
            npm run lint || echo "Lint failed (non-blocking)"
          else
            echo "⚠️  Lint script not found, skipping"
          fi
      
      - name: Build frontend
        working-directory: frontend
        run: |
          if [ -f "package.json" ] && grep -q '"build"' package.json; then
            npm run build || echo "Build failed (non-blocking)"
          else
            echo "⚠️  Build script not found, skipping"
          fi

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install pylint flake8 black mypy
      
      - name: Run pylint
        working-directory: backend/api
        run: |
          pylint *.py --disable=all --enable=E,F || true
      
      - name: Run flake8
        working-directory: backend/api
        run: |
          flake8 *.py --max-line-length=120 --ignore=E501,W503 || true
      
      - name: Check code formatting
        working-directory: backend/api
        run: |
          black --check *.py tests/ || true

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, gateway-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: ump_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      clickhouse:
        image: clickhouse/clickhouse-server:latest
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 8123:8123
          - 9000:9000
        env:
          CLICKHOUSE_DB: ump_test
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytest
      
      - name: Start backend API
        working-directory: backend/api
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: ump_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          CLICKHOUSE_URL: http://localhost:8123
          DEV_MODE: "true"
        run: |
          # 安装依赖
          pip install -r requirements.txt || echo "Failed to install some dependencies (non-blocking)"
          # 启动 API
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          # 等待 API 就绪
          for i in {1..30}; do
            if curl -f http://localhost:8000/health 2>/dev/null; then
              echo "API is ready!"
              break
            fi
            echo "Waiting for API... ($i/30)"
            sleep 1
          done
      
      - name: Run E2E tests
        env:
          API_URL: http://localhost:8000
          TENANT_ID: acme
        run: |
          if [ -f "scripts/e2e_test.py" ]; then
            python3 scripts/e2e_test.py --tenant-id acme || echo "E2E tests failed (non-blocking)"
          else
            echo "⚠️  E2E test script not found, skipping"
          fi
